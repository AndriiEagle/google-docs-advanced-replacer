/**
 * ========================================
 * ТЕСТОВЫЙ ФАЙЛ для Advanced Replacer
 * ========================================
 * Этот файл содержит тестовую среду для проверки
 * функциональности замен с 15 директивами.
 */

/**
 * Создает тестовый документ с текстом для тестирования.
 * @returns {GoogleAppsScript.Document.Document} Тестовый документ.
 */
function createTestDocument() {
  const testText = `
У глибині напівзруйнованого підземелля, серед уламків каменю та іржавого заліза, промайнула тінь.

Мандрівник підвів голову й побачив, як за дерев'яною стіною периметра миготить ліхтар.

У таверні, сповненій диму й запаху дешевого елю, кілька чоловіків сиділи за одним зі столів, обговорюючи минуле й сьогодення.

На вулиці діти ганяли дерев'яну кулю, сміючись.

- А пам'ятаєте лицаря? Того, що пішов до руїн? - заговорив один, високий чоловік зі шрамом на щоці.

Тишу прорізав низький, вібруючий звук - гул, що немов народжувався із самої землі.

Його постать була гігантською і потворною. Нахилившись вперед, воно спостерігало за поселенням, ніби вибираючи жертву.

Вдалині, серед дерев, почали миготіти тіні. Вони рухалися хаотично, але неухильно наближалися.

Голос пролунав із барикад. Це був різкий і гучний наказ, ледь помітний для його слуху, але сенс був зрозумілий: "Стріляти!"

Ще один залп стріл полетів у Мандрівника, але в цей момент над обрієм показалося сонце.

- Залиш, - суворо сказав він. - Цей меч - його.

З лісу, руйнуючи кущі та дерева, вирвалася величезна істота, схожа на гібрид чорного слона і бегемота.

- Це марно! Ми не можемо його зупинити! - кричав один із солдатів, відступаючи до залишків барикади.

Монстр, заревівши з новою силою, кинувся на нього.

Село завмерло. Люди повільно почали виходити зі своїх укриттів, хтось дивився із захопленням, хтось - із жахом.
`;
  
  const doc = DocumentApp.create('Test Document for Advanced Replacer');
  const body = doc.getBody();
  body.clear();
  body.appendParagraph(testText);
  
  return doc;
}

/**
 * Полный набор тестовых директив (все 15).
 */
function getTestDirectives() {
  return [
    {
      "fragment": "У глибині напівзруйнованого підземелля, серед уламків каменю та іржавого заліза, промайнула тінь.",
      "replaceWith": "У глибині напівзруйнованого підземелля, серед уламків каменю та іржавого заліза, промайнула тінь — скрегіт заліза по каменю нагадував, що десь нагорі ходить той самий Древній Пес, чий ритм роками служив колисковою для мешканців."
    },
    {
      "fragment": "Мандрівник підвів голову й побачив, як за дерев'яною стіною периметра миготить ліхтар.",
      "replaceWith": "Мандрівник підвів голову й побачив силует: по зовнішньому колу села, спотикаючись у тумані, рухалася понівечена металева істота. Від броні лишилося не більше сорока відсотків, половина морди зірвана, лівий сенсор давно згас. Клапани шипіли, випускаючи обпалюючий пар із запахом гарячого мастила. Замість задніх лап — пара бронеспиць-штоків, крізь які тягнуться гідравлічні вали; вони віджимають органіку, перетворюючи її на чорні глинясті капсули-відходи, що удобрюють землю навколо Круга. Кожен крок супроводжувався вібрацією, ніби втомлений двигун от-от розсиплеться."
    },
    {
      "fragment": "У таверні, сповненій диму й запаху дешевого елю, кілька чоловіків сиділи за одним зі столів, обговорюючи минуле й сьогодення.",
      "replaceWith": "У таверні, де змішалися дим, дешевий ель і ледь вловимий запах гарячого мастила, що просочувався крізь щілини, кілька чоловіків сиділи за столом. Кожного разу, коли ззовні лунав шерех зламаної шестерні Древнього, вони метали погляди на стелю, ніби там могла звалитися вся їхня віра у безпеку."
    },
    {
      "fragment": "На вулиці діти ганяли дерев'яну кулю, сміючись.",
      "replaceWith": "На вулиці діти ганяли дерев'яну кулю, поки не почувся різкий злам ритму Древнього. Сміх урвався: найменший затулив вуха, а старша дівчинка прошепотіла молитву — не Богам, а «старому Псу», бо знала: якщо він упаде, їх ніхто не захистить."
    },
    {
      "fragment": "- А пам'ятаєте лицаря? Того, що пішов до руїн? - заговорив один, високий чоловік зі шрамом на щоці.",
      "replaceWith": "- А пам'ятаєте лицаря? Того, що пішов до руїн? — заговорив один, високий чоловік зі шрамом на щоці. — Дурний ризик. Особливо зараз, коли навіть Древній почав давати збої. Ви чули, як змінився його ритм? Ніби метал стогне. Я сьогодні вночі чув, як він двічі спіткнувся — у хаті посипався пил зі стелі."
    },
    {
      "fragment": "Тишу прорізав низький, вібруючий звук - гул, що немов народжувався із самої землі.",
      "replaceWith": "Тишу прорізав низький, вібруючий гул. На його тлі звичний скрегіт Древнього спершу збився, а потім урвався зовсім. Люди затамували подих: навіть вітер у ту мить стих, аби почути, чи рушить Пес далі."
    },
    {
      "fragment": "Його постать була гігантською і потворною. Нахилившись вперед, воно спостерігало за поселенням, ніби вибираючи жертву.",
      "replaceWith": "Його постать була гігантською і потворною. Але очі чудовиська стежили не за хатами, а за червоним вогником поламаного Пса, який повз уздовж периметра. Воно чекало, доки вогник згасне."
    },
    {
      "fragment": "Вдалині, серед дерев, почали миготіти тіні. Вони рухалися хаотично, але неухильно наближалися.",
      "replaceWith": "Вдалині, серед дерев, почали миготіти тіні. Вони рухалися хаотично, але не переходили невидиму межу — жодна не наважувалась, поки Древній ще дихав."
    },
    {
      "fragment": "Голос пролунав із барикад. Це був різкий і гучний наказ, ледь помітний для його слуху, але сенс був зрозумілий: \"Стріляти!\"",
      "replaceWith": "— Стріляти! — пролунав наказ із барикад. Але залп не гримнув: команду перебив пронизливий, іржавий скрегіт — Древній зрізав кут і вперше за два століття зірвав свій круг. Облитий парою та мастилом корпус нісся просто на Безіменного."
    },
    {
      "fragment": "Ще один залп стріл полетів у Мандрівника, але в цей момент над обрієм показалося сонце.",
      "replaceWith": "Щелепи Пса вже за мить від горла Безіменного, коли перший промінь сонця вирвався з-за хмар. Сенсор Пса здригнувся, згас до тьмяного жовтого, механізм видав тихий, майже жалібний сигнал і, випустивши клуб гарячого мастила, впав до ніг героя."
    },
    {
      "fragment": "- Залиш, - суворо сказав він. - Цей меч - його.",
      "replaceWith": "- Залиш, — голос Старійшини тремтів; він дивився не на меч, а на нерухомий корпус Древнього. — Двохсотлітній ритм згас. Безіменний… ти розірвав наш Круг. Впустіть його: тепер він — наша надія й наше прокляття."
    },
    {
      "fragment": "З лісу, руйнуючи кущі та дерева, вирвалася величезна істота, схожа на гібрид чорного слона і бегемота.",
      "replaceWith": "З лісу, трощачи кущі, вирвалась істота — гібрид чорного слона й бегемота. Вона обрушила масу на перебиту лапу Древнього: хруст металу, сморід гарячого мастила, пар і кров. Сенсор Пса спалахнув жовтим, а потім криваво-червоним: аварійний режим. Тиск у системах стрибнув за межі, з корпусу повалив перегрітий пар."
    },
    {
      "fragment": "- Це марно! Ми не можемо його зупинити! - кричав один із солдатів, відступаючи до залишків барикади.",
      "replaceWith": "- Це марно! Ми не можемо його зупинити! — вигукнув солдат, коли Пес відстрілив залишки задніх лап, перетворивши праву передню на бур зі спицями. Ліву заклинило, сипонули іскри. Щелепа посилилась додатковими пластинами, і Древній — асиметричний, павукоподібний — кинувся в атаку, тягнучи за собою шлейф пари."
    },
    {
      "fragment": "Монстр, заревівши з новою силою, кинувся на нього.",
      "replaceWith": "Монстр заревів і стрибнув, але Пес уже бурив його плоть: спиці ввійшли в коліно, щелепа тягла металеве тіло вгору. Діставшись сліпої зони між лопатками, Древній розкрив посилену пащу — м'ясо й кістки змішалися з мастилом. Бегемот пав, а з його тіла виповз Пес, залитий нутрощами, сенсор догас. Поселення зустріло тишу, якої боялося все життя."
    },
    {
      "fragment": "Село завмерло. Люди повільно почали виходити зі своїх укриттів, хтось дивився із захопленням, хтось - із жахом.",
      "replaceWith": "— Ви чули?.. — прошепотіла жінка біля дверей. — Більше немає кроків. І раптом до всіх дійшло: весь цей час він не лише відганяв чудовиськ — він перетворював їх на добриво, годував цю землю. Тепер ліс голодний… Діти, що визирали з-під лавок, уперше побачили, як дорослі впали на коліна й шепочуть молитву не Богам, а тіні старого Пса. Ніхто не знав, що буде далі."
    }
  ];
}

/**
 * Основная тестовая функция.
 */
function runCompleteTest() {
  console.log('🚀 Начинаю полный тест Advanced Replacer...');
  
  const testDirectives = getTestDirectives();
  
  try {
    clearOperationLogs();
    logOperation('INFO', '🎯 Начинаю полный тест с директивами...');
    
    // Запускаем обработку
    const preview = generatePreview(testDirectives, { aiThreshold: 0.4 });
    
    // Результаты теста
    const testResults = {
      totalDirectives: testDirectives.length,
      foundMatches: preview.length,
      matchedDirectives: preview.filter(p => p.type === 'EXACT').length,
      failedDirectives: testDirectives.length - preview.length,
      fixerStats: preview.length > 0 ? preview[0].fixerStats : null
    };
    
    // Детальный отчет
    console.log('\n📊 РЕЗУЛЬТАТЫ ТЕСТА:');
    console.log(`✅ Найдено совпадений: ${testResults.foundMatches}/${testResults.totalDirectives}`);
    console.log(`✅ Точные совпадения: ${testResults.matchedDirectives}`);
    console.log(`❌ Неудачные директивы: ${testResults.failedDirectives}`);
    
    if (testResults.fixerStats) {
      console.log(`🤖 Smart Fixer: ${testResults.fixerStats.totalFixed}/${testResults.fixerStats.totalDirectives} исправлено`);
    }
    
    // Проверяем каждую директиву
    console.log('\n📋 ДЕТАЛЬНЫЙ АНАЛИЗ:');
    testDirectives.forEach((directive, index) => {
      const match = preview.find(p => p.fragment && p.fragment.includes(directive.fragment.substring(0, 30)));
      if (match) {
        console.log(`✅ Директива ${index + 1}: НАЙДЕНА (${match.type})`);
      } else {
        console.log(`❌ Директива ${index + 1}: НЕ НАЙДЕНА`);
        console.log(`   Фрагмент: "${directive.fragment.substring(0, 50)}..."`);
      }
    });
    
    // Показываем логи
    console.log('\n📄 ЛОГИ ОПЕРАЦИЙ:');
    const logs = getOperationLogs();
    logs.forEach(log => {
      console.log(`[${log.timestamp}] ${log.level}: ${log.message}`);
    });
    
    console.log('\n🎉 ТЕСТ ЗАВЕРШЕН!');
    console.log(`📊 Общий результат: ${testResults.foundMatches}/${testResults.totalDirectives} директив успешно обработано`);
    
    return testResults;
    
  } catch (error) {
    console.error('💥 ОШИБКА В ТЕСТЕ:', error);
    logOperation('ERROR', `💥 Критическая ошибка в тесте: ${error.message}`);
    throw error;
  }
}

/**
 * Простой тест для проверки работы одной директивы.
 */
function runSimpleTest() {
  console.log('🔍 Запуск простого теста...');
  
  const simpleDirective = [{
    "fragment": "У глибині напівзруйнованого підземелля, серед уламків каменю та іржавого заліза, промайнула тінь.",
    "replaceWith": "У глибині напівзруйнованого підземелля, серед уламків каменю та іржавого заліза, промайнула тінь — скрегіт заліза по каменю нагадував, що десь нагорі ходить той самий Древній Пес."
  }];
  
  try {
    const result = generatePreview(simpleDirective, { aiThreshold: 0.4 });
    console.log('✅ Простой тест прошел успешно!');
    console.log(`📊 Результат: ${result.length} совпадений найдено`);
    return result;
  } catch (error) {
    console.error('❌ Простой тест не прошел:', error);
    throw error;
  }
}

/**
 * Главная функция для запуска всех тестов.
 */
function runAllTests() {
  console.log('🚀 ЗАПУСК ВСЕХ ТЕСТОВ Advanced Replacer 🚀');
  console.log('================================================');
  
  const results = {};
  
  try {
    // Тест 1: Простой тест
    console.log('\n1️⃣ Простой тест...');
    results.simple = runSimpleTest();
    
    // Тест 2: Полный тест с директивами
    console.log('\n2️⃣ Полный тест с директивами...');
    results.full = runCompleteTest();
    
    console.log('\n🎉 ВСЕ ТЕСТЫ ЗАВЕРШЕНЫ УСПЕШНО! 🎉');
    console.log('================================================');
    
    return results;
    
  } catch (error) {
    console.error('💥 КРИТИЧЕСКАЯ ОШИБКА В ТЕСТАХ:', error);
    throw error;
  }
}

/**
 * Запускает тест с точными 15 директивами пользователя.
 */
function runUserDirectivesTest() {
  console.log('🎯 ТЕСТ С ТОЧНЫМИ 15 ДИРЕКТИВАМИ ПОЛЬЗОВАТЕЛЯ 🎯');
  console.log('================================================');
  
  // Ваши точные 15 директив
  const userDirectives = [
    {
      "fragment": "У глибині напівзруйнованого підземелля, серед уламків каменю та іржавого заліза, промайнула тінь.",
      "replaceWith": "У глибині напівзруйнованого підземелля, серед уламків каменю та іржавого заліза, промайнула тінь — скрегіт заліза по каменю нагадував, що десь нагорі ходить той самий Древній Пес, чий ритм роками служив колисковою для мешканців.",
      "usedLayer": "ПС-ПесСтімпанк — Рання звукова відсилання до Вартового ще до появи на сцені.",
      "RKL": 1
    },
    {
      "fragment": "Мандрівник підвів голову й побачив, як за дерев'яною стіною периметра миготить ліхтар.",
      "replaceWith": "Мандрівник підвів голову й побачив силует: по зовнішньому колу села, спотикаючись у тумані, рухалася понівечена металева істота. Від броні лишилося не більше сорока відсотків, половина морди зірвана, лівий сенсор давно згас. Клапани шипіли, випускаючи обпалюючий пар із запахом гарячого мастила. Замість задніх лап — пара бронеспиць-штоків, крізь які тягнуться гідравлічні вали; вони віджимають органіку, перетворюючи її на чорні глинясті капсули-відходи, що удобрюють землю навколо Круга. Кожен крок супроводжувався вібрацією, ніби втомлений двигун от-от розсиплеться.",
      "usedLayer": "ПС-ПесСтімпанк — Перше детальне візуальне знайомство Безіменного з Древнім, біо-техногенні лапи.",
      "RKL": 1
    },
    {
      "fragment": "У таверні, сповненій диму й запаху дешевого елю, кілька чоловіків сиділи за одним зі столів, обговорюючи минуле й сьогодення.",
      "replaceWith": "У таверні, де змішалися дим, дешевий ель і ледь вловимий запах гарячого мастила, що просочувався крізь щілини, кілька чоловіків сиділи за столом. Кожного разу, коли ззовні лунав шерех зламаної шестерні Древнього, вони метали погляди на стелю, ніби там могла звалитися вся їхня віра у безпеку.",
      "usedLayer": "ПС-ПесСтімпанк — Паралельний кадр: страх дорослих у таверні.",
      "RKL": 1
    },
    {
      "fragment": "На вулиці діти ганяли дерев'яну кулю, сміючись.",
      "replaceWith": "На вулиці діти ганяли дерев'яну кулю, поки не почувся різкий злам ритму Древнього. Сміх урвався: найменший затулив вуха, а старша дівчинка прошепотіла молитву — не Богам, а «старому Псу», бо знала: якщо він упаде, їх ніхто не захистить.",
      "usedLayer": "ПС-ПесСтімпанк — Паралельний кадр: реакція дітей на збій ритму.",
      "RKL": 1
    },
    {
      "fragment": "- А пам'ятаєте лицаря? Того, що пішов до руїн? - заговорив один, високий чоловік зі шрамом на щоці.",
      "replaceWith": "- А пам'ятаєте лицаря? Того, що пішов до руїн? — заговорив один, високий чоловік зі шрамом на щоці. — Дурний ризик. Особливо зараз, коли навіть Древній почав давати збої. Ви чули, як змінився його ритм? Ніби метал стогне. Я сьогодні вночі чув, як він двічі спіткнувся — у хаті посипався пил зі стелі.",
      "usedLayer": "ПС-ПесСтімпанк — Плітки про несправність Вартового.",
      "RKL": 1
    },
    {
      "fragment": "Тишу прорізав низький, вібруючий звук - гул, що немов народжувався із самої землі.",
      "replaceWith": "Тишу прорізав низький, вібруючий гул. На його тлі звичний скрегіт Древнього спершу збився, а потім урвався зовсім. Люди затамували подих: навіть вітер у ту мить стих, аби почути, чи рушить Пес далі.",
      "usedLayer": "ПС-ПесСтімпанк — Аритмія Вартового, колективний страх.",
      "RKL": 1
    },
    {
      "fragment": "Його постать була гігантською і потворною. Нахилившись вперед, воно спостерігало за поселенням, ніби вибираючи жертву.",
      "replaceWith": "Його постать була гігантською і потворною. Але очі чудовиська стежили не за хатами, а за червоним вогником поламаного Пса, який повз уздовж периметра. Воно чекало, доки вогник згасне.",
      "usedLayer": "ПС-ПесСтімпанк — Фокус загрози на Псі.",
      "RKL": 1
    },
    {
      "fragment": "Вдалині, серед дерев, почали миготіти тіні. Вони рухалися хаотично, але неухильно наближалися.",
      "replaceWith": "Вдалині, серед дерев, почали миготіти тіні. Вони рухалися хаотично, але не переходили невидиму межу — жодна не наважувалась, поки Древній ще дихав.",
      "usedLayer": "ПС-ПесСтімпанк — Свідома облога.",
      "RKL": 1
    },
    {
      "fragment": "Голос пролунав із барикад. Це був різкий і гучний наказ, ледь помітний для його слуху, але сенс був зрозумілий: \"Стріляти!\"",
      "replaceWith": "— Стріляти! — пролунав наказ із барикад. Але залп не гримнув: команду перебив пронизливий, іржавий скрегіт — Древній зрізав кут і вперше за два століття зірвав свій круг. Облитий парою та мастилом корпус нісся просто на Безіменного.",
      "usedLayer": "ПС-ПесСтімпанк — Зіткнення з легендою.",
      "RKL": 2
    },
    {
      "fragment": "Ще один залп стріл полетів у Мандрівника, але в цей момент над обрієм показалося сонце.",
      "replaceWith": "Щелепи Пса вже за мить від горла Безіменного, коли перший промінь сонця вирвався з-за хмар. Сенсор Пса здригнувся, згас до тьмяного жовтого, механізм видав тихий, майже жалібний сигнал і, випустивши клуб гарячого мастила, впав до ніг героя.",
      "usedLayer": "ПС-ПесСтімпанк — Впізнавання й колапс.",
      "RKL": 2
    },
    {
      "fragment": "- Залиш, - суворо сказав він. - Цей меч - його.",
      "replaceWith": "- Залиш, — голос Старійшини тремтів; він дивився не на меч, а на нерухомий корпус Древнього. — Двохсотлітній ритм згас. Безіменний… ти розірвав наш Круг. Впустіть його: тепер він — наша надія й наше прокляття.",
      "usedLayer": "ПС-ПесСтімпанк — Наслідки зупинки Пса.",
      "RKL": 2
    },
    {
      "fragment": "З лісу, руйнуючи кущі та дерева, вирвалася величезна істота, схожа на гібрид чорного слона і бегемота.",
      "replaceWith": "З лісу, трощачи кущі, вирвалась істота — гібрид чорного слона й бегемота. Вона обрушила масу на перебиту лапу Древнього: хруст металу, сморід гарячого мастила, пар і кров. Сенсор Пса спалахнув жовтим, а потім криваво-червоним: аварійний режим. Тиск у системах стрибнув за межі, з корпусу повалив перегрітий пар.",
      "usedLayer": "ПС-ПесСтімпанк (1/3) — Запуск аварійного протоколу.",
      "RKL": 2
    },
    {
      "fragment": "- Це марно! Ми не можемо його зупинити! - кричав один із солдатів, відступаючи до залишків барикади.",
      "replaceWith": "- Це марно! Ми не можемо його зупинити! — вигукнув солдат, коли Пес відстрілив залишки задніх лап, перетворивши праву передню на бур зі спицями. Ліву заклинило, сипонули іскри. Щелепа посилилась додатковими пластинами, і Древній — асиметричний, павукоподібний — кинувся в атаку, тягнучи за собою шлейф пари.",
      "usedLayer": "ПС-ПесСтімпанк (2/3) — Трансформація перед боєм.",
      "RKL": 2
    },
    {
      "fragment": "Монстр, заревівши з новою силою, кинувся на нього.",
      "replaceWith": "Монстр заревів і стрибнув, але Пес уже бурив його плоть: спиці ввійшли в коліно, щелепа тягла металеве тіло вгору. Діставшись сліпої зони між лопатками, Древній розкрив посилену пащу — м'ясо й кістки змішалися з мастилом. Бегемот пав, а з його тіла виповз Пес, залитий нутрощами, сенсор догас. Поселення зустріло тишу, якої боялося все життя.",
      "usedLayer": "ПС-ПесСтімпанк (3/3) — Фінальний акт і смерть Вартового.",
      "RKL": 2
    },
    {
      "fragment": "Село завмерло. Люди повільно почали виходити зі своїх укриттів, хтось дивився із захопленням, хтось - із жахом.",
      "replaceWith": "— Ви чули?.. — прошепотіла жінка біля дверей. — Більше немає кроків. І раптом до всіх дійшло: весь цей час він не лише відганяв чудовиськ — він перетворював їх на добриво, годував цю землю. Тепер ліс голодний… Діти, що визирали з-під лавок, уперше побачили, як дорослі впали на коліна й шепочуть молитву не Богам, а тіні старого Пса. Ніхто не знав, що буде далі.",
      "usedLayer": "ПС-ПесСтімпанк — Епілог: настання нової доби без Вартового, санітарний фінал.",
      "RKL": 2
    }
  ];

  try {
    clearOperationLogs();
    logOperation('INFO', '🎯 Тест с точными 15 директивами пользователя...');
    
    // Запускаем обработку
    const preview = generatePreview(userDirectives, { aiThreshold: 0.4 });
    
    // Результаты теста
    const testResults = {
      totalDirectives: userDirectives.length,
      foundMatches: preview.length,
      exactMatches: preview.filter(p => p.type === 'EXACT').length,
      aiMatches: preview.filter(p => p.type === 'AI').length,
      failedDirectives: userDirectives.length - preview.length,
      fixerStats: preview.length > 0 ? preview[0].fixerStats : null
    };
    
    // Детальный отчет
    console.log('\n📊 РЕЗУЛЬТАТЫ ТЕСТА:');
    console.log('================================================');
    console.log(`✅ Всего директив: ${testResults.totalDirectives}`);
    console.log(`✅ Найдено совпадений: ${testResults.foundMatches}`);
    console.log(`✅ Точные совпадения: ${testResults.exactMatches}`);
    console.log(`🤖 AI совпадения: ${testResults.aiMatches}`);
    console.log(`❌ Не найдено: ${testResults.failedDirectives}`);
    console.log(`📈 Процент успеха: ${Math.round((testResults.foundMatches / testResults.totalDirectives) * 100)}%`);
    
    if (testResults.fixerStats) {
      console.log(`🔧 Smart Fixer исправил: ${testResults.fixerStats.totalFixed}/${testResults.fixerStats.totalDirectives} директив`);
    }
    
    // Анализ каждой директивы
    console.log('\n📋 ДЕТАЛЬНЫЙ АНАЛИЗ КАЖДОЙ ДИРЕКТИВЫ:');
    console.log('================================================');
    userDirectives.forEach((directive, index) => {
      const match = preview.find(p => p.fragment && p.fragment.includes(directive.fragment.substring(0, 50)));
      const status = match ? '✅ НАЙДЕНА' : '❌ НЕ НАЙДЕНА';
      const type = match ? `(${match.type})` : '';
      
      console.log(`${index + 1}. ${status} ${type}`);
      console.log(`   Фрагмент: "${directive.fragment.substring(0, 60)}..."`);
      console.log(`   Слой: ${directive.usedLayer}`);
      console.log(`   RKL: ${directive.RKL}`);
      console.log('');
    });
    
    // Показываем логи
    console.log('\n📄 ЛОГИ ОПЕРАЦИЙ:');
    console.log('================================================');
    const logs = getOperationLogs();
    logs.forEach(log => {
      console.log(`[${log.timestamp}] ${log.level}: ${log.message}`);
    });
    
    console.log('\n🎉 ТЕСТ ЗАВЕРШЕН!');
    console.log('================================================');
    console.log(`📊 ИТОГОВЫЙ РЕЗУЛЬТАТ: ${testResults.foundMatches}/${testResults.totalDirectives} директив обработано успешно`);
    
    return testResults;
    
  } catch (error) {
    console.error('💥 ОШИБКА В ТЕСТЕ:', error.message);
    console.error('Stack trace:', error.stack);
    logOperation('ERROR', `💥 Критическая ошибка в тесте: ${error.message}`);
    throw error;
  }
}

/**
 * Симулирует работу с тестовым документом без создания реального файла.
 */
function runTestWithoutDocument() {
  console.log('🔬 СИМУЛЯЦИОННЫЙ ТЕСТ (без создания документа) 🔬');
  console.log('================================================');
  
  try {
    // Создаем имитацию текущего документа
    const mockDocument = {
      body: createMockBody(),
      elements: createMockElements()
    };
    
    // Запускаем тест с вашими директивами
    const result = runUserDirectivesTest();
    
    console.log('\n🎯 СИМУЛЯЦИОННЫЙ ТЕСТ ЗАВЕРШЕН УСПЕШНО!');
    return result;
    
  } catch (error) {
    console.error('💥 ОШИБКА В СИМУЛЯЦИОННОМ ТЕСТЕ:', error);
    throw error;
  }
}

/**
 * Создает имитацию элементов документа для тестирования.
 */
function createMockElements() {
  const testText = `У глибині напівзруйнованого підземелля, серед уламків каменю та іржавого заліза, промайнула тінь.

Мандрівник підвів голову й побачив, як за дерев'яною стіною периметра миготить ліхтар.

У таверні, сповненій диму й запаху дешевого елю, кілька чоловіків сиділи за одним зі столів, обговорюючи минуле й сьогодення.

На вулиці діти ганяли дерев'яну кулю, сміючись.

- А пам'ятаєте лицаря? Того, що пішов до руїн? - заговорив один, високий чоловік зі шрамом на щоці.

Тишу прорізав низький, вібруючий звук - гул, що немов народжувався із самої землі.

Його постать була гігантською і потворною. Нахилившись вперед, воно спостерігало за поселенням, ніби вибираючи жертву.

Вдалині, серед дерев, почали миготіти тіні. Вони рухалися хаотично, але неухильно наближалися.

Голос пролунав із барикад. Це був різкий і гучний наказ, ледь помітний для його слуху, але сенс був зрозумілий: "Стріляти!"

Ще один залп стріл полетів у Мандрівника, але в цей момент над обрієм показалося сонце.

- Залиш, - суворо сказав він. - Цей меч - його.

З лісу, руйнуючи кущі та дерева, вирвалася величезна істота, схожа на гібрид чорного слона і бегемота.

- Це марно! Ми не можемо його зупинити! - кричав один із солдатів, відступаючи до залишків барикади.

Монстр, заревівши з новою силою, кинувся на нього.

Село завмерло. Люди повільно почали виходити зі своїх укриттів, хтось дивився із захопленням, хтось - із жахом.`;
  
  return testText.split('\n\n').map((paragraph, index) => ({
    text: paragraph.trim(),
    originalIndex: index,
    id: `test_element_${index}`,
    typeName: 'PARAGRAPH'
  }));
}

/**
 * Создает имитацию тела документа.
 */
function createMockBody() {
  return {
    getText: () => createMockElements().map(e => e.text).join('\n\n'),
    getType: () => 'BODY_SECTION'
  };
} 